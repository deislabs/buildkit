#!/usr/bin/env bash

. $(dirname $0)/util

: ${PLATFORMS=linux/arm}

importCacheFlags=""
if [ -n "$cacheref" ]; then
  if [ "$cachetype" = "local" ]; then
    importCacheFlags="--cache-from=type=local,src=$cacheref"
  else
    importCacheFlags="--cache-from=type=registry,ref=$cacheref:binaries"
  fi
fi

set -ex

if [ -n "$MASTERCACHE_PASSWORD" ] && [ -n "$RUNC_PLATFORMS" ]; then
  repo="cicache.buildk.it/moby/buildkit/master"
  $(dirname $0)/login_ci_cache
  docker buildx build $progressFlag \
    --target "binaries-linux-helper" \
    --platform "$RUNC_PLATFORMS" \
    --output "type=image,push=true,name=$repo:binaries-cross-helper" \
    --cache-from "type=registry,ref=cicache.buildk.it/moby/buildkit/master:binaries-cross-helper" \
    --cache-to "type=inline" \
    $currentcontext
fi

docker buildx build $progressFlag \
  --platform "$PLATFORMS" \
  --cache-from "type=registry,ref=cicache.buildk.it/moby/buildkit/master:binaries-cross-helper" \
  $currentcontext

docker buildx build $progressFlag \
  --target "buildkit-buildkitd" \
  --platform "windows/amd64" \
  --cache-from "type=registry,ref=cicache.buildk.it/moby/buildkit/master:binaries" \
  $currentcontext
